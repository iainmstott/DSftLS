
# DATA HANDLING AND MANAGEMENT


Create a new .R file in the folder you wish to use as your working directory, to
use in this session.

Tidy Data --> Plot --> Model --> Model Check --> Results.  

The worksheet comes in two parts. 

* In the first part, you'll work with the 
[ShinyGLiM app](https://iainmstott.shinyapps.io/ShinyGLiM)
to find out what code you would write to achieve certain tasks in R. 
* In the second part,
you'll work with real scientific data to apply your new knowledge to real scientific
questions.  
\

Again, type in the commands rather than copy-pasting...
\

Whilst you do part 1, you might want to copy code from the app into your .R 
file: in part 2 it might be useful to edit it to get the answers you need!
\

***
## RESOURCES

Books:
 
* Beckerman, Childs & Petchey (2017) _Getting started with R, an 
introduction for Biologists_, 2nd ed. pp 35 - 78, Chapter 2, "Getting your 
data into R" and Chapter 3, "Data management, manipulation and exploration".
\ 

Cheatsheets:

* Week 1: data transformation with dplyr cheatsheet by RStudio - 
see Resources section on blackboard or download 
[here](https://github.com/rstudio/cheatsheets/raw/master/data-transformation.pdf)

Web links:

* [R for beginners](https://education.rstudio.com/learn/beginner") by RStudio
\ 

[__ShinyGLiM__](https://iainmstott.shinyapps.io/ShinyGLiM)  
\

## PACKAGES

You'll need to load the right packages every time you complete worksheets. In 
this session, we will be working with:

 * `readr`, which helps load in data
 * `dplyr`, which is our data subsetting and manipulation friend

 ```{r eval = FALSE}
library(readr)
library(dplyr)
 ```
\


***
## DATA HANDLING
We've learned some basic stuff in R: objects, classes, assignments, functions,
arguments, outputs, comments. Importantly we've learned of a few common classes
of object that we'll often encounter during our R adventures: numeric, 
character, factor, logical, data.frame. We've learned how 
R works, with the base packages providing the basic functionality, which can be
built upon to get R to work for whatever you might imagine (within reason). 
These add-on thingies are called __packages__ and you store them in your R 
__library__. (R aficionados will tell you not to confuse "package" and "library":
you load packages, which are stored in youur library, and their brains 
explode if you tell them you're loading the library).  

We've also learned about __Tidy Data__. Tidy data allows you, as analyst padawans, 
to easily subset and manipulate data, so you're working with the data that you 
need to be working with.  

In this session, we're going to learn common means of manipulating data. From 
here on, we'll be using a collection of packages, built by RStudio, called the
[__tidyverse__](https://www.tidyverse.org) (although we'll only be using a 
few of the ones that are on offer). The tidyverse is a new, emerging way of 
programming in R. It's fast becoming the standard way of coding, athough 
old-schoolers like me have taken a while to get used to it.  

In this particular session, we're going to acquaint ourselves with the 
[`dplyr`](https://dplyr.tidyverse.org/) package. `dplyr` is an expert 
data-wrangler which you can use to organise and manipulate data ready for 
plotting and analysis. We'll be learning:

* how to read data into R
* how to subset data
   + `slice()` and `filter()` to choose certain rows of the `data.frame`
   + `select()` to choose certain columns of the `data.frame`
* how to manipulate data
   + how to add a variable to the `data.frame` using `mutate()`
   + how to arrange the `data.frame` by variable values using `arrange()`
* how to use __pipes__ to make coding neater and cleaner.  
\


***
***
## PART 1
  
 \

## USER GUIDE

Read the USER GUIDE for ShinyGLiM. At this point, we'll just be working on the 
first step: _Tidy Data_. The first thing you want to do, on the User Guide page, 
is choose your data. However for now there's only one data set: the 'games'
data we collected last week... plus some extra data: and yes, I made some of your 
other lecturers do the tasks too!  
\

## SUBSETTING DATA
On the DATA tab, you can see the games data. There are two panels on the right 
hand side: DATA FRAME and CODE (if your browser window is narrow or you're 
using a smartphone or a tablet then these might be at the bottom of the 
page). Click on the CODE tab. These two lines of 
code are what you need to read in the games data and get R to show it.  

On the left are some options. You can choose rows by row numbers or variable 
values, and columns by column numbers or column names.  
\

### `slice()`
First we'll pick some rows by their number using `slice`. Change the row numbers 
slider to pick a subset of the dataframe rows. 

* check that the DATA FRAME displayed has changed like you expect it to
* take a look at the CODE panel to see how it's changed  

_Question: which of the above topics (reading data, `slice()`, `filter()`, 
`select()`, `mutate()`, pipe) are we using in this code?_  
\

Note how we assign `<-` the smallest and largest row values to 
`rows` and then use these values later to subset the data with `seq()` and 
`slice()`.  

_Question: Why might we want to take this approach rather than just using 
the values directly?_  

_Question: Based on what you learned in the basic R worksheet, how could you 
achieve the same subset of data with a slightly different approach in 
specifying the rows to take out?_  
\

You'll notice that we use a __pipe__ `%>%` in this code:

```{r eval = FALSE}
dataSubset <- data %>%
    slice( seq(rows[1], rows[2], 1) )
```

The pipe is a way of taking whatever you have and then passing it to the next
function. So, here we take `data`, and then pass it to `slice()` to chop out 
some rows. We could do this a different way without a pipe:

```{r eval = FALSE}
dataSubset <- slice(data, seq(rows[1], rows[2], 1) )
```

For something short like we're doing here, this might make sense. But as you 
need to do more and more things with your data, this gets more complicated as 
you end up with functions inside functions, parentheses within parentheses...  
\

### `select()`
As an example of how the pipe is useful, let's also choose certain columns. 
For now we'll choose by column number. Pick "Choose by... Column numbers" and 
change the slider to whatever values you want. Check the DATA FRAME to check 
you have the right ones, then check the CODE to see what you have. Notice that
there's a further step in the data subsetting.  
```{r eval = FALSE}
dataSubset <- data %>%
    slice( seq(rows[1], rows[2], 1) ) %>%
        select( seq(cols[1], cols[2], 1) ) 
```

_Question: using information from the R basics worksheet, how would you choose 
columns (or rows) that aren't in a sequence, for example only columns 2 and 4?_  
\

Let's imagine what that the above code would look like without pipes...

```{r eval = FALSE}
dataSubset <- select(slice(data, seq(rows[1], rows[2], 1) ), seq(cols[1], cols[2], 1))
```
 
Yeah, not great. Lesson: pipes _are_ great!  
\

Most of the time we don't want to (or more accurately shouldn't) select a 
column using its number. We have variables, and those variables are named, 
and we're much less likely to make a mistake if we use those names rather 
than picking the wrong number. Choose the option to choose columns using variable 
names, and take out whichever ones you feel like. Note how the code then changes, 
and you're selecting variables by name instead of by number. That's way more trustworthy.  

_Question: What could you write instead of the code you now see, if you just 
wanted to remove one of the variables? Hint... the answer can be found in the
section on ´select()´ in Getting Started with R._  
\


### `filter()`
Selecting rows using numbers is also not the best way to go about things. Choose 
the option to select rows using variable values.  

There's a bit more thinking with this one. Cast your brain back to the R basics
worksheet and what a _logical_ is. In the text box you can see there, you can type
any logical that involves any of the variables, using any of the logical 
operators you encountered in the R basics exercise (or other ones as well if you
know them!). Think about whether the variable is continuous or categorical, and 
which logical operators work with which variables. Here are some ideas to 
start: `pict_cards >= 1` gives you every person who got at least 1 picture card;
`role == "student"` gives you all the values for students.  

_Task: subset the data to rows for people with negative forward fold numbers. 
If you think you know how, subset the data to rows for people with negative 
forward fold numbers_ __&__ _who are students. Hint: there's a bold statement 
there indicating how you might do that._
\


## ADDING VARIABLES

Sometimes we might want to add a variable to the data frame that's some kind of
function of one or more other variables.  
\

### `mutate()`
`mutate()` is the function we'll use to add variables. Imagine, for example, 
that you realised your ruler was snapped and started at 5cm. That would mean all
the reaction measures are 5cm too high! So, choose the option to add a variable. 
Pick a name for this corrected reaction measure, write in the correct code for its 
value and add it to the data. Take a look at the code to see what's changed.  

_Question: is it possible to add this variable before we subset the data? Would
we always want to add afterwards, or before, or a mix?_
\


***
## PART 2

We'll now put some of that learning into practise with a few tasks with the 
data. Try and complete these on your own, without consulting the app, and
I'm sure you copied the code over from the app as was suggested, so you can
edit that as you need to. First, pretty simple, but pretty important...  
\

_Task: read in the games data_  
\

You're interested in whether luck truly is a real thing in life, as you think
men are unluckier than any other gender. Drawing a picture card is unlucky, as 
picture cards look at you funny and you're pretty sure they're up to no good.
Drawing a black card is luckier than drawing a red card, as red is the colour 
of the devil. There are several steps to preparing your data...  

_Task: prepare your lucky, lucky data..._

* _You don't want to use any data from people who drew 4 cards, as 4 represents 
the 4 horsemen of the apocalypse. Remove any data where someone chose 4 cards._
* _You don't care about any variable that isn't associated with the cards, except
for the identity of the person: their gender and their group. Get rid of the 
variables you don't care about._
* _You need to know how many non-picture cards there were for each person, so
calculate that and add it to your data._
\

_Questions:_

* _How many rows of data do you have left?_
* _What function would you use to arrange the rows of the data frame by the number of 
picture cards drawn? (Hint: see the Getting Started with R book)... can you 
write the code that would do that?_
* _What's the mean total number of black cards drawn?_
* _What are the mean numbers of picture cards drawn, separately for each gender? 
Hint: you can look at p. 71 of Getting Started With R for this one, and we'll
encounter it later in the course as well._
\


***
## FINAL TIPS

That's a whistle-stop tour in data tidying. I'd encourage you to also look at 
p.75 of _Getting Started With R_ which shows how this information maps on to
the _base-R_ methods for working with `data.frame`s. Most people will use these, 
and they can sometimes be quicker and easier when you just have something 
very simple to do (this is a general rule with the `tidyverse` packages: 
often if you have something quick to do, then the base-R approach is better). 
Either approach is equally as valid.  
\

Note how I write R code: where there are spaces, what the indentation looks like,
etc. This is code _formatting_ and there's an accepted standard for what it 
should look like. Confusingly, it does matter in some instances where you do or 
do not put a space, but most of the time you can put a space (in fact as many spaces 
as you like), wherever you want. It's not the end of the world if you don't keep 
to the proper standards, but it does make code way easier to read.


